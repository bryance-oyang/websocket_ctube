<html>
	<head>
		<title>Websocket Ctube Demo</title>
	</head>
	<body>
		<h1>Websocket Ctube Demo</h1>
		<p>Example use case: heat equation is solved in real time with a C program.</p>
		<p>Data is transmitted from the C program to all connected websocket clients in a non-blocking manner (via separate threads) so the main C code can continue to run.</p>
		<p>Realtime simulation data from C program visualized below: blowtorch adds heat to metal plate which is also actively cooled.</p>

		<canvas id="the_it" width=300 height=300></canvas>

		<script lang="javascript">
			const canvas = document.getElementById("the_it");
			const ctx = canvas.getContext("2d", {willReadFrequently: true});

			// open websocket connection with C program matching the port
			websocket = new WebSocket("ws://localhost:9743");
			websocket.binaryType = "arraybuffer";
			websocket.onmessage = async (event) => {
				// get image data transmitted by the C program
				const data = new DataView(event.data)
				const img = new ImageData(100, 100);
				const npix = 100*100;
				for (let i = 0; i < npix; i++) {
					// red green blue alpha
					img.data[4*i+0] = data.getUint8(3*i+0);
					img.data[4*i+1] = data.getUint8(3*i+1);
					img.data[4*i+2] = data.getUint8(3*i+2);
					img.data[4*i+3] = 255;
				}

				// draw C program data on HTML5 canvas
				const bitmap = await createImageBitmap(img);
				ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
			}
		</script>
	</body>
</html>
