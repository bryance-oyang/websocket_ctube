<!-- Example webpage connecting to websocket ctube server to receive real-time C program data.  -->

<html>
  <head>
    <title>WebSocket Ctube Demo</title>
  </head>
  <body>
    <h1>WebSocket Ctube Demo: Heat Equation Visualizer</h1>
    <div id="loading_div">

    </div>

    <div id="main_div">
      <p>Example use case: heat equation PDE is solved in real time with a C program.</p>
      <p>Data is transmitted from the C program to all connected websocket clients in a non-blocking manner (via separate threads) so the main C code can continue to run during network operations.</p>
      <p>Realtime simulation data from C program visualized below: blowtorch adds heat to metal plate which is also actively cooled.</p>

      <canvas id="the_it" width=300 height=300></canvas>

      <p>Neat sidenote: the sRGB colors here are computed from a physical blackbody spectrum.</p>
    </div>

    <script lang="javascript">
      const loading_div = document.getElementById("loading_div");
      const canvas = document.getElementById("the_it");
      const ctx = canvas.getContext("2d", {willReadFrequently: true});

      function loading() {
          loading_div.innerHTML = "<h3>Loading: connecting to WebSocket Ctube server... (did you run ./demo.sh?)</h3>";
          loading_div.style.display = "flex";
          loading_div.style.color = "#aa0000";
          loading_div.style.fontWeight = "bold";

          main_div.style.color = "#808080";
      }

      // open websocket connection with C program matching the port
      function connect() {
        websocket = new WebSocket("ws://localhost:9743");
        websocket.binaryType = "arraybuffer";

        websocket.onclose = (event) => {
          loading();
          console.log("trying reconnect to websocket server");
          setTimeout(connect, 1000);
        }

        websocket.onopen = (event) => {
          loading_div.innerHTML = "<h3>Connected</h3>";
          loading_div.style.display = "flex";
          loading_div.style.color = "#00aa00";

          main_div.style.color = "black";;
        }

        websocket.onmessage = async (event) => {
          // get image data transmitted by the C program
          const data = new DataView(event.data)
          const img = new ImageData(100, 100);
          const npix = 100*100;
          for (let i = 0; i < npix; i++) {
            // red green blue alpha
            img.data[4*i+0] = data.getUint8(3*i+0);
            img.data[4*i+1] = data.getUint8(3*i+1);
            img.data[4*i+2] = data.getUint8(3*i+2);
            img.data[4*i+3] = 255;
          }

          // draw C program data on HTML5 canvas with resizing
          const bitmap = await createImageBitmap(img);
          ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
        }
      }
      loading();
      connect();
    </script>
  </body>
</html>
